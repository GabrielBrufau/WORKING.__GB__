->iniciamos el proyecto
npm init -y
->instalamos herramientas
npm install express pg pg-hstore sequelize morgan @babel/polyfill
npm install --save-dev @babel/core @babel/cli @babel/preset-env
->configurar el archivo .babelrc para que tradusca codigo moderno de javascript
```bash
{
    "presets":[
        "@babel/preset-env"
    ]
} 
```
->creamos el archivo src/index.js y escribimos codigo moderno de js
->vamos a archivo de package.json y configuramos el script para que babel tome el file src y de un directorio de salida dist 

```bash
"script":{
    "build": "babel src/index.js -d dist"
}
```
->npm run built crea ese archivo dist este usamos cuando queremos desplegar la aplicacion
->configuamos el package.json para cuando estamos en produccion
```bash
"script":{
    "start": "npm run build && node dist/index.js"
}
```
Now let's start our server.

$ npm start
You should now be able to visit http://127.0.0.1:1337 and see Hello World
-> mirar cuando el archivo cambia con nodemon
npm install --save-dev nodemon
-> cambiamos el package.json 
```bash
 "scripts": {
    "build": "babel index.js -d dist",
-   "start": "npm run build && node dist/index.js"
+   "start": "npm run build && nodemon dist/index.js"
  }
```
->Preparación para el uso de producción
mkdir src
mv index.js src/index.js
->actualizar el script para que tome los cambios
"build": "babel src -d dist",
->creamos el en produccion en el script
"serve": "node dist/index.js"
->agregamos un .gitignore
touch .gitignore
->testear el server
npm install --save-dev mocha
mkdir test
touch test/index.js
npm install --save-dev @babel/register
-> creamos carpetas y archivos
touch app.js
mkdir controlers // aca van a estar las funciones que se ejecutan cuando los usuarios visiten las rutas
mkdir model
mkdir routes
mkdir database
-> en app importamos express y lo usamos y lo exportamos para usarlo en index.js
```javascript
import express,{json} from 'express';
const app = express();
export default app;
```
->para ir viendo por consola las peticiones que van llegando usamos morgan
```javascript
import express,{json} from 'express';
import morgan from 'morgan'
const app = express();

//middlewares
app.use(morgan('dev'));//muestra por consola lo que va llegando 
app.use(json());//entiende los archivos .json

export default app;
```
->hacer las rutas
touch routes/nombrederuta.js
```javascript
import { Router } from 'express';
const router = Router();



export default router;
```
->para usarlas vamos a app
```javascript
import express,{json} from 'express';
import morgan from 'morgan'

//initializations
const app = express();

//Importing routes
import projectRoutes from './routes/projects';
import tasksRoutes from './routes/tasks';

//middlewares
app.use(morgan('dev'));//muestra por consola lo que va llegando 
app.use(json());//entiende los archivos .json

//routes
app.use(projectRoutes);
app.use(tasksRoutes);

export default app;
```
->en cuanto a los prefijos de las rutas
```javascript
import express,{json} from 'express';
import morgan from 'morgan'

//initializations
const app = express();

//Importing routes
import projectRoutes from './routes/projects';
import taskRoutes from './routes/tasks';

//middlewares
app.use(morgan('dev'));//muestra por consola lo que va llegando 
app.use(json());//entiende los archivos .json

//routes
app.use('/api/projects',projectRoutes);
app.use('/api/tasks',taskRoutes);

export default app;
```
->vamos a usar app en index.js recuerda que app.listen lleva un tiempo de ejecucion por lo que es mejor usar async await en la funcion que llame a app.listen
```javascript
import app from './app';

async function main(){
    await app.listen();
    console.log('server on port 3000')
}
main()
```
->ahora hay que ir a .babelrc reparar errores 
-> podemos ver informacion de arrores aca
https://babeljs.io/docs/en/babel-plugin-transform-runtime
instalamos
npm install --save-dev @babel/plugin-transform-runtime
npm install --save @babel/runtime
->configuramos el archivo .babelrc
```bash
{
    "presets": ["@babel/preset-env"],
    "plugins": [
      [
        "@babel/plugin-transform-runtime",
        {
          "absoluteRuntime": false,
          "corejs": false,
          "helpers": true,
          "regenerator": true,
          "version": "7.0.0-beta.0"
        }
      ]
    ]
  }
```
-> para este punto deberiamos tener un cant not get en el localhost 3000 esto quiere decir que las rutas estan vacias
-> pongamos algo en la base de datos 
mkdir sql
touch sql/bd.sql
```sql
CREATE TABLE IF NOT EXISTS projects(
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name text NOT NULL CHECK (name <> ''),
    priority integer NOT NULL,
    description text,
    deliverydate date NOT NULL
);

CREATE TABLE IF NOT EXISTS tasks(
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name text NOT NULL CHECK (name <> ''),
    done BOOLEAN,
    projectId INTEGER REFERENCES projects(id)
);

INSERT INTO projects(name,priority,description,deliverydate)
    VALUES('make a web App',1,'Using Javascript','2019-05-12');

INSERT INTO projects(name,priority,description,deliverydate)
    VALUES('make and app',1,'Using Darck','2019-05-13');

INSERT INTO projects(name,priority,description,deliverydate)
    VALUES('make a Desktop app',2,'Using C++','2019-05-14');

--insert taks data
INSERT INTO tasks(name,done,projectId)
    VALUES('donwload Vuejs',false,1);

INSERT INTO tasks(name,done,projectId)
    VALUES('Create Ui web',false,1);

INSERT INTO tasks(name,done,projectId)
    VALUES('donwload Fluter',false,2);

INSERT INTO tasks(name,done,projectId)
    VALUES('Desing UI',false,2);
```
CHECK (name <> '') // esto revisa que el nombre no este en blanco
->abrimos pgadmin 4 de posgrest
->conectammos la basededatos
touch database/database.js
```javascript
import Sequelize from 'sequelize';

export const sequelize = new Sequelize(
    'node-posgresql-api-rest',
    'postgres',
    'toor',
    {
        host:'localhost',
        dialect:'postgres',
        pool:{
            max:5,
            min:0,
            require:30000,
            idle:10000
        },
        logging:false
    }
)
```
logging:false //no muestra mensajes en consola
->importemos la coneccion en model
touch model/Project.js
touch model/tasks.js
-> en el archivo model
```javascript
import Sequelize from 'sequelize';
import { sequelize } from '../database/database'
```
->definir el modelo de dato de mi base de datos y le damos sus propiedades
```javascript
//model/projects.js
import Sequelize from 'sequelize';
import { sequelize } from '../database/database';

const Project = sequelize.define('projects',{
    id:{
        type:Sequelize.INTEGER,
        primaryKey:true
    },
    name:{
        type:Sequelize.TEXT
    },
    priority:{
        type:Sequelize.INTEGER
    },
    description:{
        type:Sequelize.TEXT
    },
    deliverydate:{
        type:Sequelize.DATE
    }
},{
    timestamps:false
})

export default Project;
```
timestamps:false //es para que no tenga problemas con la fecha
->algo parecido hacemos en model/task.js
->ahora un projecto va a tener muchas tareas relacionamos las tablas
```javascript
//model/projects.js
import Sequelize from 'sequelize';
import { sequelize } from '../database/database';

import Task from './Tasks';

const Project = sequelize.define('projects',{
    id:{
        type:Sequelize.INTEGER,
        primaryKey:true
    },
    name:{
        type:Sequelize.TEXT
    },
    priority:{
        type:Sequelize.INTEGER
    },
    description:{
        type:Sequelize.TEXT
    },
    deliverydate:{
        type:Sequelize.DATE
    }
},{
    timestamps:false
})

//relacionamos la tabla project tiene muchas tareas (hasmany)
Project.hasMany(Task,{
    foreignKey:'projectId',
    sourceKey:'id'
});
//relacionamos la tabla task tiene un project (belongsTo(project))
Task.belongsTo(Project,{
    foreignKey:'projectId',
    sourceKey:'id'
});


export default Project;
```
-> ahora  toca crear las rutas y crear los controller que den sus funciones a esas rutas
touch controller/project.controller.js
```javascript
//controller/project.controller.js
export function createProject(req,res){
    console.log(req.body);
    res.send('date received')
}
```
```javascript
//routes/projects
import { Router } from 'express';
const router = Router();

import { createProject }from '../controllers/project.controller'

router.post('/', createProject);

export default router;
```
->probamos con posman o imsomnia
le podemos mandar en el body un json
miramos el model y vamos que el id lo generea solo entonses
{
	"name":"project testing",
	"priority": 3,
	"description":"this is a test project",
	"deliverydate":"2019-10-02"
}
->para guardar esos datos en la base de datos vamos a controllers
```javascript
//controller/project.controller.js
//para poder guardar los datos traemos el schema de sequelize que esta en model
import Project from '../model/Project';


export async function createProject(req,res){
    //para extraer lo que me estan enviando en la ruta post 
    const {name, priority,description,deliverydate} = req.body;
    //guardando los datos recuerda que el guardado puede tomar tiempo asignale un await
    let newProject = await Project.create({
        name,
        priority,
        description,
        deliverydate
    })
    res.send('date received')
}

```
->para chequear si se creo el project
```javascript
//controller/project.controller.js
//para poder guardar los datos traemos el schema de sequelize que esta en model
import Project from '../model/Project';


export async function createProject(req,res){
    //para extraer lo que me estan enviando en la ruta post 
    const {name, priority,description,deliverydate} = req.body;
    //guardando los datos recuerda que el guardado puede tomar tiempo asignale un await
    let newProject = await Project.create({
        name,
        priority,
        description,
        deliverydate
    });
    if(newProject){
        res.json({
            message:'Project created successfully',
            data:newProject
        })
    }
    res.send('date received')
}
```
-->para tener un manejo de errores
```javascript
//para poder guardar los datos traemos el schema de sequelize que esta en model
import Project from "../model/Project";

export async function createProject(req, res) {
  //para extraer lo que me estan enviando en la ruta post
  const { name, priority, description, deliverydate } = req.body;
  try {
    //guardando los datos recuerda que el guardado puede tomar tiempo asignale un await
    let newProject = await Project.create({
      name,
      priority,
      description,
      deliverydate,
    });
    if (newProject) {
      return res.json({
        message: "Project created successfully",
        data: newProject
      });
    }
    res.send("date received");
  } catch (e) {
      res.status(500).json({
          message:'Somethign goes wrong',
          data:{}
      })
  }
}
```
->posiblemente salga un errror porque no le estamos diciendo cuando creamos el projecto en la base de datos que datos le vamos a pasar 
-> agregamos los datos que le pasamos a la bd
```javascript
////controller/project.controller.js
//para poder guardar los datos traemos el schema de sequelize que esta en model
import Project from "../model/Project";

export async function createProject(req, res) {
  //para extraer lo que me estan enviando en la ruta post
  const { name, priority, description, deliverydate } = req.body;
  try {
    //guardando los datos recuerda que el guardado puede tomar tiempo asignale un await
    let newProject = await Project.create({
      name,
      priority,
      description,
      deliverydate,
    },{
        fields:['name','priority','description','deliverydate']
    });
    if (newProject) {
      return res.json({
        message: "Project created successfully",
        data: newProject
      });
    }
    res.send("date received");
  } catch (error) {
      console.log(error);
      res.status(500).json({
          message:'Somethign goes wrong',
          data:{}
      })
  }
}
```
->para consultar datos 
```javascript
//controller/project.controller.js
//para poder guardar los datos traemos el schema de sequelize que esta en model
import Project from "../model/Project";

//consultar datos
export async function getProjects(req,res){
  const project = await Project.findAll();
  res.json({
    data:project
  });
}

//crear datos
export async function createProject(req, res) {
  //para extraer lo que me estan enviando en la ruta post
  const { name, priority, description, deliverydate } = req.body;
  try {
    //guardando los datos recuerda que el guardado puede tomar tiempo asignale un await
    let newProject = await Project.create({
      name,
      priority,
      description,
      deliverydate,
    },{
        fields:['name','priority','description','deliverydate']
    });
    if (newProject) {
      return res.json({
        message: "Project created successfully",
        data: newProject
      });
    }
    res.send("date received");
  } catch (error) {
      console.log(error);
      res.status(500).json({
          message:'Somethign goes wrong',
          data:{}
      })
  }
}//RUNING

```
->agregar un manejo de errores
```javascript
//controller/project.controller.js
//consultar datos 
export async function getProjects(req,res){
  try{
  const project = await Project.findAll();
  res.json({
    data:project
  });
  }catch(e){
    console.log(e)
  }
}//RUNING
```
->para usar este gerproject
```javascript
//routes/project.js
import { Router } from 'express';
const router = Router();

import { createProject,getProjects }from '../controllers/project.controller'

router.post('/', createProject);
router.get('/',getProjects);
export default router;
```
->pedir los datos de un solo project atraves de req.params
```javascript
//controllers/project.controller.js
//consultar datos de un solo project
export async function getOneProject(req,res){
  const { id } = req.params;
  const project = await Project.findOne({
    where:{
      id:id
    }
  });
  res.json({
    data:project
  });
}
```
-> para usar este getOneProject
```javascript
//routes/Project
import { Router } from 'express';
const router = Router();

import { createProject,getProjects,getOneProject }from '../controllers/project.controller'

// /api/projects/
router.post('/', createProject);
router.get('/',getProjects);

// /api/projects/:projectID
router.get('/:id',getOneProject);


export default router;
```
->para eliminar un project
```javascript
//controllers/projects.controllers.js
//eliminar project
export async function deleteProject(req,res){
  const {id} = req.params;
  const deleteRowCount = await Project.destroy({
    where:{
      id
    }
  });
  res.json({
    message:'Project Deleted succesfully',
    count:deleteRowCount
  });
}

```
->para usar este controlador
```javascript 
//routes/project.js
import { Router } from 'express';
const router = Router();

import { createProject,getProjects,getOneProject,deleteProject }from '../controllers/project.controller'

// /api/projects/
router.post('/', createProject);
router.get('/',getProjects);

// /api/projects/:projectID
router.get('/:id',getOneProject);
router.delete('/:id',deleteProject);


export default router;

```
->para actualizar los project nesecitamos el req.paramas y el req.body
```javascript
//controllers/project/controllers.js
//actulizar los projectos
export async function updateProject(req,res){
  //lo que voy a actualizar
  const {id}= req.params;
  //los datos que voy a actualizar
  const { name,priority,description,deliverydate}=req.body

  //buscando todos los projectos
  const projects = await Project.findAll({
    attributes:['id','name','priority','description','deliverydate'],
    where:{
      id
    }
  });

  //recorriendo cada project y actualizarlos
  if(projects.length > 0 ){
    projects.forEach(async project => {
      await project.update({
        name,
        priority,
        description,
        deliverydate
      });
    });
  }

  //dandole una respuesta al usuario 
  return res.json({
    message:'Project Update Successfully',
    data:projects
  })
}

```
->para usar este controllers
```javascript
//routes/Project.js
import { Router } from 'express';
const router = Router();

import { createProject,getProjects,getOneProject,deleteProject,updateProject }from '../controllers/project.controller'

// /api/projects/
router.post('/', createProject);
router.get('/',getProjects);

// /api/projects/:projectID
router.get('/:id',getOneProject);
router.delete('/:id',deleteProject);
router.put('/:id',updateProject);


export default router;
```

->ahora sigamos con las tareas
->touch controllers/task.controllers.js
->para crear una tarea vamos a nesecitar req.body
```javascript
//controllers/Task.controllers.js
import Task from '../model/Tasks';

export async function createTask(req,res){
    const {name,done,projectId} = req.body;
    const newTask = await Task.create({
        name,
        done,
        projectId
    },{
        fields:['name','done','projectId']
    });
    res.json({message:'new task created'});
}

```
->para usar este controlador
```javascript 
//routes/Tasks.js
import { Router } from 'express';
const router = Router();

import { createTask } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);

export default router;
```
->para optener todas las tareas
```javascript
//controllers/task.controllers.js
export async function getTasks(req,res){
    const Tasks = await Task.findAll({
        attributes:['id','projectid','name','done'],
        order:[
            ['id','DESC']
        ]
    });
    res.json({Tasks})
}
```
->para usar este controlador
```javascript
//routes/tasks.js
import { Router } from 'express';
const router = Router();

import { createTask,getTasks } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);
router.get('/',getTasks);

export default router;

```
->para eliminar una tarea nesecito saver cual tarea quiero eliminar mediante id por lo que esto lo se con mi req.params
```javascript
//controllers/task.controller.js
export async function deleteTask(req,res){
    const {id} = req.params;
    await Task.destroy({
        where:{
            id
        }
    });
    res.json({message:'Task deleted'});
}
```
->vamos a utilizar este controllers
```javascript
//routes/task.js
import { Router } from 'express';
const router = Router();

import { createTask,deleteTask,getTasks } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);
router.get('/',getTasks);

// /api/tasks/:id
router.delete('/:id',deleteTask);

export default router;
```
->actualizar task 
->para actualizar tenemos que buscar porel id que pasan de req.params
-> y traer los atributos que me pasan de body
```javascript
//controll4ers/task.controllers.js
export async function updateTask(req,res){
    const {id}=req.params;
    const {projectid,name,done}=req.body;

    const task = await Task.findOne({
        attributes:['name','projectid','done','id'],
        where:{id}
    });

    const updatedTask = await Task.update({
        name,
        done,
        projectid
    },{where:{id}});

    res.json({
        message:'Task Updated',
        updatedTask
    })
}
```
->para usar este controllers update

```javascript
//routes/tasks
import { Router } from 'express';
import { updateProject } from '../controllers/project.controller';
const router = Router();

import { createTask,deleteTask,getTasks, updateTask } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);
router.get('/',getTasks);

// /api/tasks/:id
router.delete('/:id',deleteTask);
router.put('/:id',updateTask);
export default router;
```
-> buscar una tarea
```javascript
//controllers/task.controller.js
export async function getOneTask(req,res){
    const {id} = req.params;
    
    const task = await Task.findOne({
        where:{
            id
        },
        attributes:['id','projectid','name','done']
    });
    res.json({task});
}

```
->usar este controllers
```javascript
//routes/tasks.js
import { Router } from 'express';
import { updateProject } from '../controllers/project.controller';
const router = Router();

import { createTask,deleteTask,getOneTask,getTasks, updateTask } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);
router.get('/',getTasks);

// /api/tasks/:id
router.delete('/:id',deleteTask);
router.put('/:id',updateTask);
router.get('/:id',getOneTask)


export default router;
```
->buscar las tareas deacuerdo al projecto
->para esto nesecitamos cambiar un poco las rutas 
->primero vamos a controllers
```javascript
//controllers/task.controller.js
export async function getTasksByProject(req,res){
    const {projectid}=req.params;
    const tasks = await Task.findAll({
        attributes:['id','projectid','done','name'],
        where:{projectid}
    });
    res.json({tasks})
}
```
->lo usamos en routes
```javascript
// reutes/task.js
import { Router } from 'express';
import { updateProject } from '../controllers/project.controller';
const router = Router();

import { createTask,deleteTask,getOneTask,getTasks, updateTask } from '../controllers/task.controller'

// /api/tasks/
router.post('/',createTask);
router.get('/',getTasks);

// /api/tasks/:id
router.delete('/:id',deleteTask);
router.put('/:id',updateTask);
router.get('/:id',getOneTask)

// /api/tasks/project/:projectid
router.get('/project/:projectid')

export default router;
```
